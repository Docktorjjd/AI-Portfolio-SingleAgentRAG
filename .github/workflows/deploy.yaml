name: CI â€¢ Validate & Deploy

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

env:
  PYTHON_VERSION: "3.10"
  NOTEBOOK_NAME: "single_agent_rag_clean.ipynb" # change if needed
  HF_SPACE: "Docktorjjd/SingleAgentRAG"         # your Space name (owner/space)

jobs:
  validate-notebook:
    name: ğŸ§ª Validate notebook
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: ğŸ“¦ Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install nbformat nbconvert ipykernel

      - name: ğŸ” Check notebook exists (skip if not)
        id: nb_check
        run: |
          if [ ! -f "$NOTEBOOK_NAME" ]; then
            echo "found=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Notebook '$NOTEBOOK_NAME' not found. Skipping execution."
          else
            echo "found=true" >> $GITHUB_OUTPUT
          fi

      - name: â–¶ï¸ Execute notebook
        if: steps.nb_check.outputs.found == 'true'
        run: |
          jupyter nbconvert --to notebook --execute --inplace "$NOTEBOOK_NAME"

  prepare-docs:
    name: ğŸ—‚ï¸ Ensure docs folder
    runs-on: ubuntu-latest
    needs: [validate-notebook]
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“ Ensure docs/ exists
        run: |
          mkdir -p docs
          # (Optional) Ensure placeholders exist so links never 404
          [ -f docs/AI_Portfolio_Roadmap.pdf ] || echo "Roadmap PDF placeholder" > docs/README.txt

      - name: â¬†ï¸ Commit docs scaffolding (if changed)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs || true
          git diff --cached --quiet || git commit -m "chore: ensure docs/ present via CI"
          git push || true

  deploy-huggingface:
    name: ğŸš€ Deploy to Hugging Face Spaces
    runs-on: ubuntu-latest
    needs: [validate-notebook]   # wait for validation
    if: github.ref == 'refs/heads/main'          # only on main
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§° Install CLI
        run: |
          python -m pip install --upgrade pip
          pip install -U huggingface_hub

      - name: ğŸ” Login to HF
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          huggingface-cli login --token "$HF_TOKEN"

      - name: ğŸ“¤ Upload repo to Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          huggingface-cli upload ./ "${{ env.HF_SPACE }}" \
            --repo-type=space \
            --commit-message "CI: auto-deploy from GitHub main" \
            --token "$HF_TOKEN"

  # Optional: Streamlit Community Cloud trigger (enable after connecting repo in Streamlit Cloud)
  # streamlit-ping:
  #   name: ğŸŒ Ping Streamlit Cloud (optional)
  #   runs-on: ubuntu-latest
  #   needs: [validate-notebook]
  #   if: github.ref == 'refs/heads/main'
  #   steps:
  #     - name: â±ï¸ No-op step (Streamlit Cloud rebuilds on push automatically)
  #       run: echo "If your repo is connected to Streamlit Community Cloud, it redeploys on push."
